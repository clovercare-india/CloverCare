rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    /* ===================== HELPERS ===================== */

    function isSignedIn() {
      return request.auth != null;
    }

    function isAdmin() {
      return isSignedIn() && (
        (userExists(request.auth.uid) && user(request.auth.uid).data.role == 'admin') ||
        (request.auth.email != null && 
         exists(/databases/$(database)/documents/users/$(request.auth.email)) &&
         get(/databases/$(database)/documents/users/$(request.auth.email)).data.role == 'admin')
      );
    }

    function user(uid) {
      return get(/databases/$(database)/documents/users/$(uid));
    }

    function userExists(uid) {
      return exists(/databases/$(database)/documents/users/$(uid));
    }

    function role(uid) {
      return userExists(uid) ? user(uid).data.role : null;
    }

    function isCareManager() {
      return role(request.auth.uid) == 'caremanager';
    }

    function isAssignedCareManager(seniorId) {
      return seniorId != null && userExists(seniorId)
        && role(seniorId) == 'senior'
        && user(seniorId).data.get('careManagerId', null) == request.auth.uid;
    }

    function isLinkedFamily(seniorId) {
      return seniorId != null && userExists(seniorId)
        && role(seniorId) == 'senior'
        && user(seniorId).data.get('linkedFamily', []) is list
        && request.auth.uid in user(seniorId).data.get('linkedFamily', []);
    }

    /* ===================== GLOBAL ADMIN RULE ===================== */
    
    match /{document=**} {
      allow read, write, delete: if isAdmin();
    }

    /* ===================== USERS ===================== */

    match /users/{userId} {
      allow read: if isSignedIn() || 
        (request.auth == null && resource.data.get('role', null) == 'caremanager');
      
      allow list: if isSignedIn() || request.auth == null;

      allow create: if isSignedIn() && (
        (request.auth.uid == userId && request.resource.data.get('role', null) != 'admin') ||
        (role(request.auth.uid) == 'family' && 
         request.resource.data.get('role', null) == 'senior' &&
         request.auth.uid in request.resource.data.get('linkedFamily', []))
      );

      allow update: if isSignedIn() && (
        (request.auth.uid == userId && !request.resource.data.diff(resource.data).affectedKeys().hasAny(['role'])) ||
        (
          role(request.auth.uid) == 'family' &&
          resource.data.role == 'senior' &&
          request.resource.data.diff(resource.data).affectedKeys().hasOnly(['linkedFamily', 'updatedAt']) &&
          request.resource.data.linkedFamily is list &&
          resource.data.get('linkedFamily', []) is list &&
          request.resource.data.linkedFamily.hasAll(resource.data.get('linkedFamily', [])) &&
          request.resource.data.linkedFamily.size() == resource.data.get('linkedFamily', []).size() + 1 &&
          request.auth.uid in request.resource.data.linkedFamily
        ) ||
        (
          role(request.auth.uid) == 'caremanager' &&
          resource.data.role == 'senior' &&
          request.resource.data.diff(resource.data).affectedKeys().hasOnly(['careManagerId', 'updatedAt', 'lastHealthLogAt'])
        )
      );

      allow delete: if isAdmin() || (
        role(request.auth.uid) == 'caremanager' &&
        resource.data.role == 'caremanager' &&
        resource.data.userId != request.auth.uid
      );
    }

    /* ===================== HEALTH LOGS ===================== */

    match /healthLogs/{id} {
      allow read: if isSignedIn() && (
        request.auth.uid == resource.data.seniorId ||
        isAssignedCareManager(resource.data.seniorId) ||
        isLinkedFamily(resource.data.seniorId) ||
        isAdmin()
      );
      
      allow list: if isSignedIn();
      
      allow create: if isSignedIn() && (
        request.auth.uid == request.resource.data.seniorId ||
        (isCareManager() && request.resource.data.careManagerId == request.auth.uid)
      );

      allow update: if isSignedIn() && isAssignedCareManager(resource.data.seniorId);
    }

    /* ===================== ALERTS ===================== */

    match /alerts/{id} {
      allow read: if isSignedIn() && (
        request.auth.uid == resource.data.userId ||
        isAssignedCareManager(resource.data.userId) ||
        isLinkedFamily(resource.data.userId) ||
        isAdmin()
      );
      
      allow list: if isSignedIn();
      
      allow create: if isSignedIn() && request.auth.uid == request.resource.data.userId;

      allow update: if isSignedIn() && (
        request.auth.uid == resource.data.userId ||
        isAssignedCareManager(resource.data.userId) ||
        isLinkedFamily(resource.data.userId) ||
        isAdmin()
      );
    }

    /* ===================== REMINDERS ===================== */

    match /reminders/{id} {
      allow read: if isSignedIn() && (
        request.auth.uid == resource.data.userId ||
        isAssignedCareManager(resource.data.userId) ||
        isLinkedFamily(resource.data.userId) ||
        isAdmin()
      );
      
      allow list: if isSignedIn();
      
      allow create, update: if isSignedIn() && (
        request.auth.uid == request.resource.data.userId || 
        isAssignedCareManager(request.resource.data.userId) || 
        isLinkedFamily(request.resource.data.userId)
      );
    }

    /* ===================== ROUTINES ===================== */

    match /routines/{id} {
      allow read: if isSignedIn() && (
        request.auth.uid == resource.data.userId ||
        isAssignedCareManager(resource.data.userId) ||
        isLinkedFamily(resource.data.userId) ||
        isAdmin()
      );
      
      allow list: if isSignedIn();
      
      allow create: if isSignedIn() && (
        request.auth.uid == request.resource.data.userId || 
        isAssignedCareManager(request.resource.data.userId) ||
        isLinkedFamily(request.resource.data.userId)
      );
      
      allow update: if isSignedIn() && (
        request.auth.uid == resource.data.userId || 
        isAssignedCareManager(resource.data.userId) ||
        isLinkedFamily(resource.data.userId)
      );
      
      allow delete: if isSignedIn() && (
        request.auth.uid == resource.data.userId ||
        isLinkedFamily(resource.data.userId)
      );
    }

    /* ===================== TASKS & CARER TASKS ===================== */

    match /tasks/{id} {
      allow read: if isSignedIn() && (
        request.auth.uid == resource.data.seniorId ||
        isAssignedCareManager(resource.data.seniorId) ||
        isLinkedFamily(resource.data.seniorId) ||
        isAdmin()
      );
      
      allow list: if isSignedIn();
      
      allow create, update: if isSignedIn() && (
        request.auth.uid == request.resource.data.seniorId ||
        isLinkedFamily(request.resource.data.seniorId) ||
        (isCareManager() && request.resource.data.careManagerId == request.auth.uid)
      );
    }

    match /carerTasks/{id} {
      allow read: if isSignedIn() && (
        request.auth.uid == resource.data.seniorId ||
        request.auth.uid == resource.data.userId ||
        isAssignedCareManager(resource.data.seniorId) ||
        isAssignedCareManager(resource.data.userId) ||
        isLinkedFamily(resource.data.seniorId) ||
        isLinkedFamily(resource.data.userId) ||
        isAdmin()
      );
      allow list: if isSignedIn();
      
      allow create, update: if isSignedIn() && (
        request.auth.uid == request.resource.data.seniorId ||
        request.auth.uid == request.resource.data.userId ||
        isLinkedFamily(request.resource.data.seniorId) ||
        isLinkedFamily(request.resource.data.userId) ||
        (isCareManager() && request.resource.data.careManagerId == request.auth.uid) ||
        (isCareManager() && resource.data.careManagerId == request.auth.uid)
      );
    }

    /* ===================== LOGS ===================== */

    match /logs/{id} {
      allow read: if isSignedIn() && (
        request.auth.uid == resource.data.userId ||
        isAssignedCareManager(resource.data.userId) ||
        isLinkedFamily(resource.data.userId) ||
        isAdmin()
      );
      allow list: if isSignedIn();
      
      allow create: if isSignedIn() && request.auth.uid == request.resource.data.userId;
      
      allow update: if isSignedIn() && (
        request.auth.uid == resource.data.userId ||
        isAssignedCareManager(resource.data.userId) ||
        isLinkedFamily(resource.data.userId)
      );
    }

    /* ===================== SERVICE REQUESTS ===================== */

    match /serviceRequests/{id} {
      allow read: if isSignedIn() && (
        request.auth.uid == resource.data.seniorId ||
        isAssignedCareManager(resource.data.seniorId) ||
        isLinkedFamily(resource.data.seniorId) ||
        isAdmin()
      );
      
      allow list: if isSignedIn();
      
      allow create, update: if isSignedIn() && (
        request.auth.uid == request.resource.data.seniorId ||
        isAssignedCareManager(request.resource.data.seniorId) || 
        isLinkedFamily(request.resource.data.seniorId)
      );
    }

    /* ===================== SCHEDULED CHECK-INS ===================== */

    match /scheduledCheckIns/{id} {
      allow read: if isSignedIn() && (
        request.auth.uid == resource.data.seniorId ||
        isAssignedCareManager(resource.data.seniorId) ||
        isLinkedFamily(resource.data.seniorId) ||
        isAdmin()
      );
      
      allow list: if isSignedIn();
      
      allow create, update: if isSignedIn() && (
        isAssignedCareManager(request.resource.data.seniorId) ||
        isLinkedFamily(request.resource.data.seniorId)
      );
    }
  }
}